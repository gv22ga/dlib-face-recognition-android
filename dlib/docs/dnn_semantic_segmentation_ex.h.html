<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - dnn_semantic_segmentation_ex.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>// The contents of this file are in the public domain. See LICENSE_FOR_EXAMPLE_PROGRAMS.txt
</font><font color='#009900'>/*
    Semantic segmentation using the PASCAL VOC2012 dataset.

    In segmentation, the task is to assign each pixel of an input image
    a label - for example, 'dog'.  Then, the idea is that neighboring
    pixels having the same label can be connected together to form a
    larger region, representing a complete (or partially occluded) dog.
    So technically, segmentation can be viewed as classification of
    individual pixels (using the relevant context in the input images),
    however the goal usually is to identify meaningful regions that
    represent complete entities of interest (such as dogs).

    Instructions how to run the example:
    1. Download the PASCAL VOC2012 data, and untar it somewhere.
       http://host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar
    2. Build the dnn_semantic_segmentation_train_ex example program.
    3. Run:
       ./dnn_semantic_segmentation_train_ex /path/to/VOC2012
    4. Wait while the network is being trained.
    5. Build the dnn_semantic_segmentation_ex example program.
    6. Run:
       ./dnn_semantic_segmentation_ex /path/to/VOC2012-or-other-images

    An alternative to steps 2-4 above is to download a pre-trained network
    from here: http://dlib.net/files/semantic_segmentation_voc2012net.dnn

    It would be a good idea to become familiar with dlib's DNN tooling before reading this
    example.  So you should read dnn_introduction_ex.cpp and dnn_introduction2_ex.cpp
    before reading this example program.
*/</font>

<font color='#0000FF'>#ifndef</font> DLIB_DNn_SEMANTIC_SEGMENTATION_EX_H_
<font color='#0000FF'>#define</font> DLIB_DNn_SEMANTIC_SEGMENTATION_EX_H_

<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>dlib<font color='#5555FF'>/</font>dnn.h<font color='#5555FF'>&gt;</font>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<font color='#0000FF'>inline</font> <font color='#0000FF'><u>bool</u></font> <b><a name='operator'></a>operator</b> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>const</font> dlib::rgb_pixel<font color='#5555FF'>&amp;</font> a, <font color='#0000FF'>const</font> dlib::rgb_pixel<font color='#5555FF'>&amp;</font> b<font face='Lucida Console'>)</font>
<b>{</b>
    <font color='#0000FF'>return</font> a.red <font color='#5555FF'>=</font><font color='#5555FF'>=</font> b.red <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> a.green <font color='#5555FF'>=</font><font color='#5555FF'>=</font> b.green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> a.blue <font color='#5555FF'>=</font><font color='#5555FF'>=</font> b.blue;
<b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<font color='#009900'>// The PASCAL VOC2012 dataset contains 20 ground-truth classes + background.  Each class
</font><font color='#009900'>// is represented using an RGB color value.  We associate each class also to an index in the
</font><font color='#009900'>// range [0, 20], used internally by the network.
</font>
<font color='#0000FF'>struct</font> <b><a name='Voc2012class'></a>Voc2012class</b> <b>{</b>
    <b><a name='Voc2012class'></a>Voc2012class</b><font face='Lucida Console'>(</font>uint16_t index, <font color='#0000FF'>const</font> dlib::rgb_pixel<font color='#5555FF'>&amp;</font> rgb_label, <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> classlabel<font face='Lucida Console'>)</font>
        : index<font face='Lucida Console'>(</font>index<font face='Lucida Console'>)</font>, rgb_label<font face='Lucida Console'>(</font>rgb_label<font face='Lucida Console'>)</font>, classlabel<font face='Lucida Console'>(</font>classlabel<font face='Lucida Console'>)</font>
    <b>{</b><b>}</b>

    <font color='#009900'>// The index of the class. In the PASCAL VOC 2012 dataset, indexes from 0 to 20 are valid.
</font>    <font color='#0000FF'>const</font> uint16_t index <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

    <font color='#009900'>// The corresponding RGB representation of the class.
</font>    <font color='#0000FF'>const</font> dlib::rgb_pixel rgb_label;

    <font color='#009900'>// The label of the class in plain text.
</font>    <font color='#0000FF'>const</font> std::string classlabel;
<b>}</b>;

<font color='#0000FF'>namespace</font> <b>{</b>
    constexpr <font color='#0000FF'><u>int</u></font> class_count <font color='#5555FF'>=</font> <font color='#979000'>21</font>; <font color='#009900'>// background + 20 classes
</font>
    <font color='#0000FF'>const</font> std::vector<font color='#5555FF'>&lt;</font>Voc2012class<font color='#5555FF'>&gt;</font> classes <font color='#5555FF'>=</font> <b>{</b>
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, <font color='#979000'>0</font>, <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'></font>"<font face='Lucida Console'>)</font>, <font color='#009900'>// background
</font>
        <font color='#009900'>// The cream-colored `void' label is used in border regions and to mask difficult objects
</font>        <font color='#009900'>// (see http://host.robots.ox.ac.uk/pascal/VOC/voc2012/htmldoc/devkit_doc.html)
</font>        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font>dlib::loss_multiclass_log_per_pixel_::label_to_ignore,
            dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>224</font>, <font color='#979000'>224</font>, <font color='#979000'>192</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>border</font>"<font face='Lucida Console'>)</font>,

        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>128</font>,   <font color='#979000'>0</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>aeroplane</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font>  <font color='#979000'>0</font>, <font color='#979000'>128</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>bicycle</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>128</font>, <font color='#979000'>128</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>bird</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>4</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font>  <font color='#979000'>0</font>,   <font color='#979000'>0</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>boat</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>5</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>128</font>,   <font color='#979000'>0</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>bottle</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>6</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font>  <font color='#979000'>0</font>, <font color='#979000'>128</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>bus</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>7</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>128</font>, <font color='#979000'>128</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>car</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>8</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font> <font color='#979000'>64</font>,   <font color='#979000'>0</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>cat</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>9</font>,  dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>192</font>,   <font color='#979000'>0</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>chair</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>10</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font> <font color='#979000'>64</font>, <font color='#979000'>128</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>cow</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>11</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>192</font>, <font color='#979000'>128</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>diningtable</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>12</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font> <font color='#979000'>64</font>,   <font color='#979000'>0</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>dog</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>13</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>192</font>,   <font color='#979000'>0</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>horse</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>14</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font> <font color='#979000'>64</font>, <font color='#979000'>128</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>motorbike</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>15</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>192</font>, <font color='#979000'>128</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>person</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>16</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font>  <font color='#979000'>0</font>,  <font color='#979000'>64</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>pottedplant</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>17</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>128</font>,  <font color='#979000'>64</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>sheep</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>18</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font>  <font color='#979000'>0</font>, <font color='#979000'>192</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>sofa</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>19</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font><font color='#979000'>128</font>, <font color='#979000'>192</font>,   <font color='#979000'>0</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>train</font>"<font face='Lucida Console'>)</font>,
        <font color='#BB00BB'>Voc2012class</font><font face='Lucida Console'>(</font><font color='#979000'>20</font>, dlib::<font color='#BB00BB'>rgb_pixel</font><font face='Lucida Console'>(</font>  <font color='#979000'>0</font>,  <font color='#979000'>64</font>, <font color='#979000'>128</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>tvmonitor</font>"<font face='Lucida Console'>)</font>,
    <b>}</b>;
<b>}</b>

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> Predicate<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>const</font> Voc2012class<font color='#5555FF'>&amp;</font> <b><a name='find_voc2012_class'></a>find_voc2012_class</b><font face='Lucida Console'>(</font>Predicate predicate<font face='Lucida Console'>)</font>
<b>{</b>
    <font color='#0000FF'>const</font> <font color='#0000FF'>auto</font> i <font color='#5555FF'>=</font> std::<font color='#BB00BB'>find_if</font><font face='Lucida Console'>(</font>classes.<font color='#BB00BB'>begin</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, classes.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, predicate<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>!</font><font color='#5555FF'>=</font> classes.<font color='#BB00BB'>end</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#0000FF'>return</font> <font color='#5555FF'>*</font>i;
    <b>}</b>
    <font color='#0000FF'>else</font>
    <b>{</b>
        <font color='#0000FF'>throw</font> std::<font color='#BB00BB'>runtime_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Unable to find a matching VOC2012 class</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<font color='#009900'>// Introduce the building blocks used to define the segmentation network.
</font><font color='#009900'>// The network first does residual downsampling (similar to the dnn_imagenet_(train_)ex 
</font><font color='#009900'>// example program), and then residual upsampling. The network could be improved e.g.
</font><font color='#009900'>// by introducing skip connections from the input image, and/or the first layers, to the
</font><font color='#009900'>// last layer(s).  (See Long et al., Fully Convolutional Networks for Semantic Segmentation,
</font><font color='#009900'>// https://people.eecs.berkeley.edu/~jonlong/long_shelhamer_fcn.pdf)
</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='BN'></a>BN</b>, <font color='#0000FF'><u>int</u></font> stride, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> 
<font color='#0000FF'>using</font> block <font color='#5555FF'>=</font> BN<font color='#5555FF'>&lt;</font>dlib::con<font color='#5555FF'>&lt;</font>N,<font color='#979000'>3</font>,<font color='#979000'>3</font>,<font color='#979000'>1</font>,<font color='#979000'>1</font>, dlib::relu<font color='#5555FF'>&lt;</font>BN<font color='#5555FF'>&lt;</font>dlib::con<font color='#5555FF'>&lt;</font>N,<font color='#979000'>3</font>,<font color='#979000'>3</font>,stride,stride,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='BN'></a>BN</b>, <font color='#0000FF'><u>int</u></font> stride, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> 
<font color='#0000FF'>using</font> blockt <font color='#5555FF'>=</font> BN<font color='#5555FF'>&lt;</font>dlib::cont<font color='#5555FF'>&lt;</font>N,<font color='#979000'>3</font>,<font color='#979000'>3</font>,<font color='#979000'>1</font>,<font color='#979000'>1</font>,dlib::relu<font color='#5555FF'>&lt;</font>BN<font color='#5555FF'>&lt;</font>dlib::cont<font color='#5555FF'>&lt;</font>N,<font color='#979000'>3</font>,<font color='#979000'>3</font>,stride,stride,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font>,<font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font><font color='#0000FF'>class</font>,<font color='#0000FF'><u>int</u></font>,<font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='block'></a>block</b>, <font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font><font color='#0000FF'>class</font> <b><a name='BN'></a>BN</b>, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> residual <font color='#5555FF'>=</font> dlib::add_prev1<font color='#5555FF'>&lt;</font>block<font color='#5555FF'>&lt;</font>N,BN,<font color='#979000'>1</font>,dlib::tag1<font color='#5555FF'>&lt;</font>SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font>,<font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font><font color='#0000FF'>class</font>,<font color='#0000FF'><u>int</u></font>,<font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='block'></a>block</b>, <font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font><font color='#0000FF'>class</font> <b><a name='BN'></a>BN</b>, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> residual_down <font color='#5555FF'>=</font> dlib::add_prev2<font color='#5555FF'>&lt;</font>dlib::avg_pool<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,dlib::skip1<font color='#5555FF'>&lt;</font>dlib::tag2<font color='#5555FF'>&lt;</font>block<font color='#5555FF'>&lt;</font>N,BN,<font color='#979000'>2</font>,dlib::tag1<font color='#5555FF'>&lt;</font>SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font>,<font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font><font color='#0000FF'>class</font>,<font color='#0000FF'><u>int</u></font>,<font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font> <font color='#0000FF'>class</font> <b><a name='block'></a>block</b>, <font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>template</font><font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font><font color='#5555FF'>&gt;</font><font color='#0000FF'>class</font> <b><a name='BN'></a>BN</b>, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>using</font> residual_up <font color='#5555FF'>=</font> dlib::add_prev2<font color='#5555FF'>&lt;</font>dlib::cont<font color='#5555FF'>&lt;</font>N,<font color='#979000'>2</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,dlib::skip1<font color='#5555FF'>&lt;</font>dlib::tag2<font color='#5555FF'>&lt;</font>blockt<font color='#5555FF'>&lt;</font>N,BN,<font color='#979000'>2</font>,dlib::tag1<font color='#5555FF'>&lt;</font>SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res       <font color='#5555FF'>=</font> dlib::relu<font color='#5555FF'>&lt;</font>residual<font color='#5555FF'>&lt;</font>block,N,dlib::bn_con,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares      <font color='#5555FF'>=</font> dlib::relu<font color='#5555FF'>&lt;</font>residual<font color='#5555FF'>&lt;</font>block,N,dlib::affine,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res_down  <font color='#5555FF'>=</font> dlib::relu<font color='#5555FF'>&lt;</font>residual_down<font color='#5555FF'>&lt;</font>block,N,dlib::bn_con,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares_down <font color='#5555FF'>=</font> dlib::relu<font color='#5555FF'>&lt;</font>residual_down<font color='#5555FF'>&lt;</font>block,N,dlib::affine,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res_up    <font color='#5555FF'>=</font> dlib::relu<font color='#5555FF'>&lt;</font>residual_up<font color='#5555FF'>&lt;</font>block,N,dlib::bn_con,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'><u>int</u></font> N, <font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares_up   <font color='#5555FF'>=</font> dlib::relu<font color='#5555FF'>&lt;</font>residual_up<font color='#5555FF'>&lt;</font>block,N,dlib::affine,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res512 <font color='#5555FF'>=</font> res<font color='#5555FF'>&lt;</font><font color='#979000'>512</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res256 <font color='#5555FF'>=</font> res<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res128 <font color='#5555FF'>=</font> res<font color='#5555FF'>&lt;</font><font color='#979000'>128</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> res64  <font color='#5555FF'>=</font> res<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares512 <font color='#5555FF'>=</font> ares<font color='#5555FF'>&lt;</font><font color='#979000'>512</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares256 <font color='#5555FF'>=</font> ares<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares128 <font color='#5555FF'>=</font> ares<font color='#5555FF'>&lt;</font><font color='#979000'>128</font>, SUBNET<font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> ares64  <font color='#5555FF'>=</font> ares<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>, SUBNET<font color='#5555FF'>&gt;</font>;


<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level1 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res512,res_down<font color='#5555FF'>&lt;</font><font color='#979000'>512</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level2 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res256,res_down<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level3 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res128,res_down<font color='#5555FF'>&lt;</font><font color='#979000'>128</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level4 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res64,res<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel1 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares512,ares_down<font color='#5555FF'>&lt;</font><font color='#979000'>512</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel2 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares256,ares_down<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel3 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares128,ares_down<font color='#5555FF'>&lt;</font><font color='#979000'>128</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel4 <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares64,ares<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level1t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res512,res_up<font color='#5555FF'>&lt;</font><font color='#979000'>512</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level2t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res256,res_up<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level3t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res128,res_up<font color='#5555FF'>&lt;</font><font color='#979000'>128</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> level4t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,res64,res_up<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel1t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares512,ares_up<font color='#5555FF'>&lt;</font><font color='#979000'>512</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel2t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares256,ares_up<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel3t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares128,ares_up<font color='#5555FF'>&lt;</font><font color='#979000'>128</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;
<font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> SUBNET<font color='#5555FF'>&gt;</font> <font color='#0000FF'>using</font> alevel4t <font color='#5555FF'>=</font> dlib::repeat<font color='#5555FF'>&lt;</font><font color='#979000'>2</font>,ares64,ares_up<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>,SUBNET<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<font color='#009900'>// training network type
</font><font color='#0000FF'>using</font> net_type <font color='#5555FF'>=</font> dlib::loss_multiclass_log_per_pixel<font color='#5555FF'>&lt;</font>
                            dlib::cont<font color='#5555FF'>&lt;</font>class_count,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,
                            level4t<font color='#5555FF'>&lt;</font>level3t<font color='#5555FF'>&lt;</font>level2t<font color='#5555FF'>&lt;</font>level1t<font color='#5555FF'>&lt;</font>
                            level1<font color='#5555FF'>&lt;</font>level2<font color='#5555FF'>&lt;</font>level3<font color='#5555FF'>&lt;</font>level4<font color='#5555FF'>&lt;</font>
                            dlib::max_pool<font color='#5555FF'>&lt;</font><font color='#979000'>3</font>,<font color='#979000'>3</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,dlib::relu<font color='#5555FF'>&lt;</font>dlib::bn_con<font color='#5555FF'>&lt;</font>dlib::con<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,
                            dlib::input<font color='#5555FF'>&lt;</font>dlib::matrix<font color='#5555FF'>&lt;</font>dlib::rgb_pixel<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                            <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// testing network type (replaced batch normalization with fixed affine transforms)
</font><font color='#0000FF'>using</font> anet_type <font color='#5555FF'>=</font> dlib::loss_multiclass_log_per_pixel<font color='#5555FF'>&lt;</font>
                            dlib::cont<font color='#5555FF'>&lt;</font>class_count,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,
                            alevel4t<font color='#5555FF'>&lt;</font>alevel3t<font color='#5555FF'>&lt;</font>alevel2t<font color='#5555FF'>&lt;</font>alevel1t<font color='#5555FF'>&lt;</font>
                            alevel1<font color='#5555FF'>&lt;</font>alevel2<font color='#5555FF'>&lt;</font>alevel3<font color='#5555FF'>&lt;</font>alevel4<font color='#5555FF'>&lt;</font>
                            dlib::max_pool<font color='#5555FF'>&lt;</font><font color='#979000'>3</font>,<font color='#979000'>3</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,dlib::relu<font color='#5555FF'>&lt;</font>dlib::affine<font color='#5555FF'>&lt;</font>dlib::con<font color='#5555FF'>&lt;</font><font color='#979000'>64</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>2</font>,<font color='#979000'>2</font>,
                            dlib::input<font color='#5555FF'>&lt;</font>dlib::matrix<font color='#5555FF'>&lt;</font>dlib::rgb_pixel<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                            <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>;

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>// DLIB_DNn_SEMANTIC_SEGMENTATION_EX_H_
</font>
</pre></body></html>